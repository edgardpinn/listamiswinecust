<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Carta de Vinhos ‚Äî Montagem</title>
  <meta name="theme-color" content="#111827" />

  <style>
    :root{
      --bg:#f4f5f7;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;

      --primary:#111827;
      --primary2:#1f2937;
      --accent:#22c55e;

      --chip:#f3f4f6;
      --shadow: 0 12px 28px rgba(15,23,42,.10);
      --radius:16px;

      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    button{font:inherit}

    .app{
      max-width: 980px;
      margin: 0 auto;
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding-bottom: calc(92px + var(--safeBottom));
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary2) 100%);
      color:#fff;
      padding: calc(12px + var(--safeTop)) 14px 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }
    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .brand b{ font-size:16px; letter-spacing:.2px; }
    .brand small{ font-size:12px; opacity:.9; }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .iconBtn{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.10);
      color:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{transform:scale(.98)}

    .content{
      padding:12px 12px 0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      background:#fff;
    }
    .cardHeader h2{
      margin:0;
      font-size:18px;
      letter-spacing:-.2px;
    }
    .cardHeader p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }

    .filters{
      padding:12px 14px;
      display:grid;
      gap:10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:#111827;
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      outline:none;
      font-size:14px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.25;
    }

    .list{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .item{
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      background:#fff;
    }
    @media (max-width: 520px){
      .item{ flex-direction:column; }
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--chip);
      border: 1px solid var(--line);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }

    .name{
      margin:0;
      font-weight:1000;
      font-size:14px;
      letter-spacing:.2px;
    }

    /* ‚úÖ VOLTA A META COM BULLETS (igual seu original) + limita em 3 linhas SEM SUMIR */
    .meta{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.2;

      /* 3 linhas (aprox): 12px * 1.2 = 14.4px -> 3 linhas ~ 44px */
      max-height: 44px;
      overflow:hidden;
    }

    .prices{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:baseline;
    }
    .p{
      font-weight:1100;
      color:#16a34a;
      white-space:nowrap;
    }
    .p small{
      color:var(--muted);
      font-weight:900;
    }

    .itemRight{
      margin-left:auto;
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      min-width: 240px;
    }
    @media (max-width: 520px){
      .itemRight{ width:100%; min-width:0; align-items:stretch; }
    }

    .qtyGrid{
      width:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      align-items:end;
    }
    .qtyMini{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .qtyMini label{
      margin:0;
      font-size:11px;
      font-weight:900;
      color:#111827;
      letter-spacing:.15px;
      text-transform:uppercase;
    }
    .qtyInput{
      width:100%;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      font-size:14px;
      text-align:right;
    }

    .addRow{
      width:100%;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }

    .btnMini{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      background: var(--accent);
      color:#052e16;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(34,197,94,.25);
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      width:100%;
    }
    .btnMini:active{transform:scale(.99)}
    .btnGhost{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }

    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:40;
      padding: 10px 12px calc(10px + var(--safeBottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
    }
    .bottomWrap{
      max-width:980px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .cartSummary{
      flex:1 1 auto;
      background:#111827;
      color:#fff;
      border-radius: 16px;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: var(--shadow);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      min-width:0;
    }
    .cartSummary:active{transform:scale(.995)}
    .cartSummary b{display:block;font-size:13px;opacity:.95}
    .cartSummary span{display:block;font-size:16px;font-weight:1000;letter-spacing:-.2px; white-space:nowrap}
    .pillCount{
      min-width:44px;
      height:36px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      font-weight:1000;
      flex:0 0 auto;
    }

    .exportBtn{
      flex:0 0 auto;
      border:none;
      border-radius: 16px;
      padding:12px 14px;
      background: var(--accent);
      color:#052e16;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(34,197,94,.25);
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .exportBtn:active{transform:scale(.98)}

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:60;
      padding: 12px 12px calc(12px + var(--safeBottom));
    }
    .overlay.show{display:flex}

    .sheet{
      width:100%;
      max-width:980px;
      background: var(--surface);
      border-radius: 22px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: calc(100vh - 24px - var(--safeTop));
      display:flex;
      flex-direction:column;
    }
    .sheetHeader{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: #fff;
      flex:0 0 auto;
    }
    .sheetHeader b{
      font-size:14px;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .closeBtn{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      -webkit-tap-highlight-color: transparent;
    }
    .closeBtn:active{transform:scale(.98)}

    .sheetBody{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .sheetFooter{
      padding:14px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      background:#fff;
      flex:0 0 auto;
      flex-wrap:wrap;
    }
    .btn{
      flex:1 1 auto;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border:none;
      color:#052e16;
    }
    .btn:active{transform:scale(.99)}

    .warn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#7f1d1d;
      font-weight:900;
      font-size:12px;
      display:none;
    }
    .warn.show{display:block}

    .pvBox{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      overflow:hidden;
    }
    .pvHeader{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pvHeader b{font-size:13px}
    .pvHeader small{color:var(--muted); font-size:12px}
    .pvTable{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .pvTable th, .pvTable td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    .pvTable th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.18px;
      color:#111827;
      background:#f9fafb;
    }
    .pvRight{text-align:right}
    .pvMono{font-variant-numeric: tabular-nums;}
  </style>
</head>

<body>
  <div class="app">

    <header class="topbar">
      <div class="toprow">
        <div class="brand">
          <b>Carta de Vinhos ‚Äî Montagem</b>
          <small id="subTitle">Filtre e monte pedido em caixas (cxs) e unidades (un) com custo em BRL</small>
        </div>
        <div class="actions">
          <button class="iconBtn" id="btnReload" type="button" title="Recarregar dados">‚Üª</button>
          <button class="iconBtn" id="btnOpenCart" type="button" title="Pedido (lista)">üßæ</button>
        </div>
      </div>
    </header>

    <main class="content">
      <div class="grid">

        <section class="card">
          <div class="cardHeader">
            <div>
              <h2>Configura√ß√£o</h2>
              <p id="lastUpdateLine">√öltima atualiza√ß√£o: ‚Äî</p>
            </div>
          </div>

          <div class="filters">

            <div class="row2">
              <div class="field">
                <label>Cliente</label>
                <input id="clientName" placeholder="Ex: Jo√£o Silva / Restaurante X..." />
                <div class="hint">Esse nome aparece na pr√©via e no PDF.</div>
              </div>
              <div class="field">
                <label>C√¢mbio USD ‚Üí BRL</label>
                <input id="fx" inputmode="decimal" placeholder="Ex: 5,12" />
                <div class="hint">Use ponto ou v√≠rgula (ex: 5.12 / 5,12).</div>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Buscar pelo nome</label>
                <input id="q" placeholder="Ex: barbaresco, gaja, catena..." />
                <div class="hint">Busca s√≥ no <b>nome/descri√ß√£o</b>.</div>
              </div>
              <div class="field">
                <label>Categoria</label>
                <select id="cat"></select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Pa√≠s</label>
                <select id="country"></select>
              </div>
              <div class="field">
                <label>Uva</label>
                <select id="grape"></select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Safra (ano)</label>
                <select id="vintage"></select>
              </div>
              <div class="field">
                <label>Tamanho (garrafa)</label>
                <select id="size"></select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Marca</label>
                <select id="brand"></select>
              </div>
              <div class="field">
                <label>Produtor</label>
                <select id="producer"></select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <label>Estoque</label>
                <select id="inStock">
                  <option value="">Todos</option>
                  <option value="1">Somente com estoque</option>
                  <option value="0">Somente sem estoque</option>
                </select>
                <div class="hint">Mostra tamb√©m as <b>cxs</b> (DUN Un) ao lado do estoque.</div>
              </div>
              <div class="field">
                <label>Ordenar</label>
                <select id="sort">
                  <option value="name">Nome (A‚ÜíZ)</option>
                  <option value="usd">Custo base (menor‚Üímaior)</option>
                  <option value="brl">Custo BRL (menor‚Üímaior)</option>
                  <option value="stock">Estoque (maior‚Üímenor)</option>
                </select>
              </div>
            </div>

            <div class="row2">
              <div class="field">
                <button class="btn" id="btnReset" type="button">Limpar filtros</button>
                <div class="hint">No celular carrega em blocos (n√£o trava).</div>
              </div>
              <div class="field">
                <div class="hint">Fonte dos dados: <b>wines_catalog.csv</b> (na raiz do site).</div>
              </div>
            </div>

          </div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h2>Cat√°logo</h2>
              <p>Digite as quantidades em <b>cx</b> / <b>un</b> e clique em <b>Adicionar</b>.</p>
            </div>
            <div class="tag" id="countTag">0 itens</div>
          </div>

          <div class="list" id="list"></div>
        </section>

      </div>
    </main>
  </div>

  <div class="bottomBar">
    <div class="bottomWrap">
      <div class="cartSummary" id="cartSummary" role="button" aria-label="Abrir pedido">
        <div>
          <b id="cartMiniTitle">Pedido (cxs + un)</b>
          <span id="cartMiniTotal">R$ 0,00</span>
        </div>
        <div class="pillCount" id="cartCount">0</div>
      </div>

      <button class="exportBtn" id="btnExport" type="button" title="Pr√©via do PDF">
        Pr√©via / Exportar
      </button>
    </div>
  </div>

  <!-- Pedido -->
  <div class="overlay" id="cartOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Pedido em caixas e unidades">
      <div class="sheetHeader">
        <div>
          <b>Pedido (cxs + un)</b>
          <div class="hint">Ajuste quantidades e depois exporte no bot√£o de baixo.</div>
        </div>
        <button class="closeBtn" id="btnCloseCart" type="button">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="warn" id="warnFx">Preencha o c√¢mbio (USD‚ÜíBRL) pra calcular o custo em BRL.</div>

        <div class="hint" id="cartMetaLine">Cliente: ‚Äî ‚Ä¢ √öltima atualiza√ß√£o: ‚Äî</div>

        <div id="cartList" style="display:flex; flex-direction:column; gap:10px;"></div>
      </div>

      <div class="sheetFooter">
        <button class="btn" id="btnClearCart" type="button">Limpar</button>
        <button class="btn primary" id="btnOpenPreview" type="button">Pr√©via do PDF</button>
      </div>
    </div>
  </div>

  <!-- Pr√©via PDF -->
  <div class="overlay" id="previewOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Pr√©via do PDF">
      <div class="sheetHeader">
        <div>
          <b>Pr√©via antes de exportar</b>
          <div class="hint">Confere os dados e clique em ‚ÄúExportar PDF‚Äù.</div>
        </div>
        <button class="closeBtn" id="btnClosePreview" type="button">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="warn" id="warnFx2">Preencha o c√¢mbio (USD‚ÜíBRL) pra calcular o custo em BRL.</div>

        <div class="pvBox">
          <div class="pvHeader">
            <div>
              <b id="pvTitle">Pedido</b><br/>
              <small id="pvMeta">‚Äî</small>
            </div>
            <div style="text-align:right">
              <b class="pvMono" id="pvTotal">R$ 0,00</b><br/>
              <small class="pvMono" id="pvCounts">0 cxs ‚Ä¢ 0 un</small>
            </div>
          </div>

          <div style="overflow:auto">
            <table class="pvTable" id="pvTable"></table>
          </div>
        </div>

        <div class="hint">No PDF sai centralizado e em formato de tabela.</div>
      </div>

      <div class="sheetFooter">
        <button class="btn" id="btnBackToCart" type="button">Voltar</button>
        <button class="btn primary" id="btnExportFinal" type="button">Exportar PDF</button>
      </div>
    </div>
  </div>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // =========================
    // HELPERS
    // =========================
    const brl = new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
    const usd = new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"});
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const byId = (id) => document.getElementById(id);

    function clampInt(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function norm(s){ return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
    function uniq(arr){ return [...new Set(arr.filter(v => v!==undefined && v!==null && String(v).trim()!==""))]; }

    function toNumSmart(v){
      if (v == null) return null;
      let s = String(v).trim();
      if (!s) return null;

      s = s.replace(/[^\d,.\-]/g,"");

      const lastComma = s.lastIndexOf(",");
      const lastDot = s.lastIndexOf(".");
      if (lastComma !== -1 && lastDot !== -1){
        const decimalIsComma = lastComma > lastDot;
        if (decimalIsComma){
          s = s.replace(/\./g,"").replace(",",".");
        } else {
          s = s.replace(/,/g,"");
        }
      } else if (lastComma !== -1){
        const parts = s.split(",");
        if (parts[1] && parts[1].length === 3){
          s = parts[0] + parts[1];
        } else {
          s = s.replace(",",".");
        }
      } else if (lastDot !== -1){
        const parts = s.split(".");
        if (parts[1] && parts[1].length === 3){
          s = parts[0] + parts[1];
        }
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pick(row, keys){
      if(!row) return null;

      for (const k of keys){
        if (row[k] != null && String(row[k]).trim() !== "") return row[k];
      }

      const rowKeys = Object.keys(row);
      for (const want of keys){
        const w = norm(want);
        const found = rowKeys.find(rk => norm(rk).startsWith(w));
        if (found && row[found] != null && String(row[found]).trim() !== "") return row[found];
      }

      return null;
    }

    function parseUSDateTimeToBR(text){
      const s = String(text||"").trim();
      if(!s) return "‚Äî";

      const d1 = new Date(s);
      if(!isNaN(d1.getTime())) return fmtBR(d1);

      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?/i);
      if(!m) return s;

      let mm = Number(m[1]);
      let dd = Number(m[2]);
      let yy = Number(m[3]); if(yy < 100) yy += 2000;

      let hh = Number(m[4] ?? 0);
      const mi = Number(m[5] ?? 0);
      const ss = Number(m[6] ?? 0);
      const ap = (m[7] || "").toUpperCase();

      if(ap === "PM" && hh < 12) hh += 12;
      if(ap === "AM" && hh === 12) hh = 0;

      const d = new Date(yy, mm-1, dd, hh, mi, ss);
      if(isNaN(d.getTime())) return s;
      return fmtBR(d);
    }

    function fmtBR(d){
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const COUNTRY_FLAG = new Map([
      ["italia","üáÆüáπ"], ["italy","üáÆüáπ"],
      ["franca","üá´üá∑"], ["france","üá´üá∑"],
      ["espanha","üá™üá∏"], ["spain","üá™üá∏"],
      ["portugal","üáµüáπ"],
      ["argentina","üá¶üá∑"],
      ["chile","üá®üá±"],
      ["uruguai","üá∫üáæ"], ["uruguay","üá∫üáæ"],
      ["brasil","üáßüá∑"], ["brazil","üáßüá∑"],
      ["estados unidos","üá∫üá∏"], ["usa","üá∫üá∏"], ["united states","üá∫üá∏"],
      ["australia","üá¶üá∫"],
      ["nova zelandia","üá≥üáø"], ["new zealand","üá≥üáø"],
      ["africa do sul","üáøüá¶"], ["south africa","üáøüá¶"],
      ["alemanha","üá©üá™"], ["germany","üá©üá™"],
      ["austria","üá¶üáπ"],
      ["suica","üá®üá≠"], ["switzerland","üá®üá≠"],
      ["grecia","üá¨üá∑"], ["greece","üá¨üá∑"],
    ]);

    function flagForCountry(country){
      const c = norm(country);
      if(!c) return "üè≥Ô∏è";
      for(const [k,v] of COUNTRY_FLAG.entries()){
        if(c.includes(k)) return v;
      }
      return "üè≥Ô∏è";
    }

    function parseBottleSizeML(text){
      const s = String(text||"").toLowerCase().replace(/\s+/g," ").trim();
      let m = s.match(/(\d+(?:[.,]\d+)?)\s*ml\b/);
      if(m){
        const v = toNumSmart(m[1]);
        return v ? Math.round(v) : null;
      }
      m = s.match(/(\d+(?:[.,]\d+)?)\s*l\b/);
      if(m){
        const v = toNumSmart(m[1]);
        return v ? Math.round(v * 1000) : null;
      }
      return null;
    }

    function sizeLabelFromML(ml){
      if(!ml) return "";
      if(ml === 750) return "750ml";
      if(ml === 1500) return "1,5L";
      if(ml === 375) return "375ml";
      if(ml === 1000) return "1L";
      return `${ml}ml`;
    }

    function calcBaseCost(row){
      const preco = toNumSmart(pick(row, ["Pre√ßo","Preco","preco","price","usd_cost"]));
      if(preco == null || !Number.isFinite(preco) || preco <= 0) return 0;
      return preco;
    }

    let data = [];
    let dataMap = new Map();
    let lastUpdateTextRaw = "‚Äî";
    let lastUpdateTextBR = "‚Äî";

    let RENDER_LIMIT = 80;
    function resetLimit(){ RENDER_LIMIT = 80; }

    const cart = []; // { id, boxes, units }

    const clientNameEl = byId("clientName");
    const fxEl = byId("fx");
    const qEl = byId("q");
    const catEl = byId("cat");
    const countryEl = byId("country");
    const grapeEl = byId("grape");
    const vintageEl = byId("vintage");
    const sizeEl = byId("size");
    const brandEl = byId("brand");
    const producerEl = byId("producer");
    const inStockEl = byId("inStock");
    const sortEl = byId("sort");

    function getClientName(){ return (clientNameEl.value || "").trim(); }
    function getFx(){ return toNumSmart(fxEl.value); }

    function unitCostBRL(w){
      const fx = getFx();
      if(!fx) return null;
      return (Number(w.base_cost||0) * fx);
    }

    function lineCostBRL(w, boxes, units){
      const perUnit = unitCostBRL(w);
      if(perUnit==null) return null;

      const dun = (w.dun_un != null && Number(w.dun_un) > 0) ? Number(w.dun_un) : null;
      const unitsPerBox = dun || 1;

      const b = Number(boxes || 0);
      const u = Number(units || 0);

      return perUnit * ((b * unitsPerBox) + u);
    }

    function fmtDiscountMax(w){
      const d = Number(w.discount_max || 0);
      if(!d) return "";
      if(d >= 0 && d <= 100) return `Desc m√°x ${d}%`;
      return `Desc m√°x ${d}`;
    }

    function fmtStockAndCxs(w){
      const estoque = Number(w.stock || 0);
      const cxs = (w.dun_un != null && Number(w.dun_un) > 0) ? Number(w.dun_un) : null;
      return cxs ? `Estoque ${estoque} | cxs ${cxs}` : `Estoque ${estoque}`;
    }

    async function loadData(){
      try{
        const res = await fetch("/wines_catalog.csv", { cache:"no-store" });
        if(!res.ok) throw new Error("N√£o consegui abrir wines_catalog.csv");

        const csvText = await res.text();
        if(!window.Papa) throw new Error("PapaParse n√£o carregou");

        const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
        if(parsed.errors && parsed.errors.length) console.warn("Erros CSV:", parsed.errors);

        const rows = parsed.data || [];
        const fields = (parsed.meta && parsed.meta.fields) ? parsed.meta.fields : [];

        if(fields.length && rows.length){
          const updatedField = fields.find(f => norm(f) === "updated") ||
                               fields.find(f => norm(f).includes("updated"));
          if(updatedField){
            lastUpdateTextRaw = (rows[0] && rows[0][updatedField]) ? String(rows[0][updatedField]).trim() : "‚Äî";
          } else {
            const lastField = fields[fields.length - 1];
            lastUpdateTextRaw = (rows[0] && rows[0][lastField]) ? String(rows[0][lastField]).trim() : "‚Äî";
          }
        } else {
          lastUpdateTextRaw = "‚Äî";
        }

        lastUpdateTextBR = (lastUpdateTextRaw && lastUpdateTextRaw !== "‚Äî")
          ? parseUSDateTimeToBR(lastUpdateTextRaw)
          : "‚Äî";

        byId("lastUpdateLine").textContent = `√öltima atualiza√ß√£o: ${lastUpdateTextBR}`;

        data = rows;
        normalizeData();
        buildFilters();
        resetLimit();
        render();
        updateCartUI(false);

      }catch(err){
        console.error(err);
        byId("list").innerHTML = `
          <div class="item" style="border-color:#fecaca;background:#fff1f2">
            <div style="flex:1">
              <p class="name" style="color:#7f1d1d">Erro carregando wines_catalog.csv</p>
              <div class="meta">
                <span>‚Ä¢ Confirma se <b>wines_catalog.csv</b> est√° publicado na raiz do site.</span>
              </div>
            </div>
          </div>
        `;
      }
    }

    function normalizeData(){
      const normalized = (data || []).map((w, i)=>{
        const id = pick(w, ["C√≥digo","Codigo","id","code"]) ?? (i+1);

        const name =
          pick(w, ["Descri√ß√£o","Descricao","Descri","name","Nome"]) ||
          pick(w, ["Produto","Produ","produto"]) ||
          "Sem nome";

        const brand = pick(w, ["Marca","brand"]) || "";
        const country = pick(w, ["Pa√≠s","Pais","Pa√≠s de","pais","country"]) || "";
        const producer = pick(w, ["Produtor","Produ","producer"]) || "";

        const category = pick(w, ["Tipo","type","Tipo de"]) || "";
        const vintage = pick(w, ["Safra","vintage","ano"]) ?? "";
        const grape = pick(w, ["Uva","grape","Tipo de uva"]) || "";
        const region = pick(w, ["Regi√£o","Regiao","region"]) || "";

        const stock = toNumSmart(pick(w, ["Estoque","stock"])) ?? 0;

        const sizeRaw = pick(w, ["Tamanho","tamanho","ml","Tipo de"]) || "";
        const size_ml = parseBottleSizeML(sizeRaw) || parseBottleSizeML(name);

        const base_cost = calcBaseCost(w);

        const discount_max = toNumSmart(pick(w, ["Desconto M√°x","Desconto Max","Desconto","desconto","Descon"])) ?? 0;
        const dun_un = toNumSmart(pick(w, ["DUN Un","DUNUn","DUN","Dun Un","DUN Un."])) ?? null;

        return {
          id: String(id),
          name: String(name),
          brand: String(brand),
          country: String(country),
          country_flag: flagForCountry(country),
          producer: String(producer),
          category: String(category),
          vintage: vintage,
          grape: String(grape),
          region: String(region),
          stock: Number(stock),
          size_ml,
          base_cost: Number(base_cost || 0),
          discount_max: Number(discount_max || 0),
          dun_un: (dun_un==null ? null : Number(dun_un))
        };
      });

      data = normalized;
      dataMap = new Map(data.map(w => [String(w.id), w]));
    }

    function fillSelect(el, values, withFlag=false){
      el.innerHTML = `<option value="">Todos</option>` + values
        .map(v=>{
          const txt = withFlag ? `${flagForCountry(v)} ${v}` : String(v);
          return `<option value="${escapeHtml(String(v))}">${escapeHtml(txt)}</option>`;
        }).join("");
    }

    function buildFilters(){
      fillSelect(catEl, uniq(data.map(d=>d.category)).sort((a,b)=> String(a).localeCompare(String(b))));
      fillSelect(countryEl, uniq(data.map(d=>d.country)).sort((a,b)=> String(a).localeCompare(String(b))), true);
      fillSelect(grapeEl, uniq(data.map(d=>d.grape)).sort((a,b)=> String(a).localeCompare(String(b))));
      fillSelect(brandEl, uniq(data.map(d=>d.brand)).sort((a,b)=> String(a).localeCompare(String(b))));
      fillSelect(producerEl, uniq(data.map(d=>d.producer)).sort((a,b)=> String(a).localeCompare(String(b))));

      const vint = uniq(data.map(d=>d.vintage)).sort((a,b)=> String(a).localeCompare(String(b)));
      fillSelect(vintageEl, vint);

      const sizes = uniq(data.map(d=> sizeLabelFromML(d.size_ml)).filter(Boolean))
        .sort((a,b)=> a.localeCompare(b));
      fillSelect(sizeEl, sizes);
    }

    const allFilterEls = [clientNameEl, fxEl, qEl, catEl, countryEl, grapeEl, vintageEl, sizeEl, brandEl, producerEl, inStockEl, sortEl];
    allFilterEls.forEach(el=>{
      el.addEventListener("input", ()=>{ resetLimit(); render(); updateCartUI(false); });
      el.addEventListener("change", ()=>{ resetLimit(); render(); updateCartUI(false); });
    });

    byId("btnReset").addEventListener("click", ()=>{
      clientNameEl.value = "";
      fxEl.value = "";
      qEl.value = "";
      catEl.value = "";
      countryEl.value = "";
      grapeEl.value = "";
      vintageEl.value = "";
      sizeEl.value = "";
      brandEl.value = "";
      producerEl.value = "";
      inStockEl.value = "";
      sortEl.value = "name";
      resetLimit();
      render();
    });

    function applyFilters(arr){
      const q = norm(qEl.value);
      const cat = catEl.value;
      const country = countryEl.value;
      const grape = grapeEl.value;
      const vint = vintageEl.value;
      const size = sizeEl.value;
      const brand = brandEl.value;
      const producer = producerEl.value;
      const inStock = inStockEl.value;

      return arr.filter(w=>{
        if(cat && String(w.category) !== String(cat)) return false;
        if(country && String(w.country) !== String(country)) return false;
        if(grape && String(w.grape) !== String(grape)) return false;
        if(vint && String(w.vintage) !== String(vint)) return false;
        if(brand && String(w.brand) !== String(brand)) return false;
        if(producer && String(w.producer) !== String(producer)) return false;

        if(size){
          const label = sizeLabelFromML(w.size_ml);
          if(label !== size) return false;
        }

        if(inStock === "1" && !(Number(w.stock||0) > 0)) return false;
        if(inStock === "0" && !(Number(w.stock||0) <= 0)) return false;

        if(q && !norm(w.name).includes(q)) return false;

        return true;
      });
    }

    function sortArr(arr){
      const s = sortEl.value;
      const copy = [...arr];

      if(s==="name"){
        copy.sort((a,b)=> String(a.name).localeCompare(String(b.name)));
      } else if (s==="usd"){
        copy.sort((a,b)=> (a.base_cost||0) - (b.base_cost||0));
      } else if (s==="brl"){
        copy.sort((a,b)=> (unitCostBRL(a) ?? Number.POSITIVE_INFINITY) - (unitCostBRL(b) ?? Number.POSITIVE_INFINITY));
      } else if (s==="stock"){
        copy.sort((a,b)=> (Number(b.stock||0) - Number(a.stock||0)));
      }
      return copy;
    }

    function renderMoreButton(total){
      const list = byId("list");
      if(RENDER_LIMIT >= total) return;

      const btn = document.createElement("button");
      btn.className = "btn";
      btn.style.marginTop = "8px";
      const next = Math.min(200, total - RENDER_LIMIT);
      btn.textContent = `Carregar mais (${next})`;
      btn.onclick = () => { RENDER_LIMIT += 200; render(); };
      list.appendChild(btn);

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "No celular carrega em blocos pra n√£o travar.";
      list.appendChild(hint);
    }

    function render(){
      const filteredAll = sortArr(applyFilters(data));
      byId("countTag").textContent = `${filteredAll.length} itens`;

      const filtered = filteredAll.slice(0, RENDER_LIMIT);

      byId("list").innerHTML = filtered.map(w=>{
        const c = unitCostBRL(w);

        const meta = [];
        if(w.country) meta.push(`${w.country_flag} ${w.country}`);
        if(w.region) meta.push(w.region);
        if(w.grape) meta.push(w.grape);
        if(w.vintage) meta.push(`Safra ${w.vintage}`);
        if(w.size_ml) meta.push(`Garrafa ${sizeLabelFromML(w.size_ml)}`);
        meta.push(fmtStockAndCxs(w));
        const dm = fmtDiscountMax(w);
        if(dm) meta.push(dm);

        return `
          <div class="item">
            <div style="min-width:0;flex:1">
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <span class="tag">${escapeHtml((w.category||"VINHO").toUpperCase())}</span>
                ${w.size_ml ? `<span class="tag">${escapeHtml(sizeLabelFromML(w.size_ml))}</span>` : ``}
                ${w.country ? `<span class="tag">${escapeHtml(w.country_flag)} ${escapeHtml(w.country)}</span>` : ``}
                ${w.brand ? `<span class="tag">${escapeHtml(w.brand)}</span>` : ``}
                ${w.producer ? `<span class="tag">${escapeHtml(w.producer)}</span>` : ``}
              </div>

              <p class="name">${escapeHtml(w.name)}</p>

              <!-- ‚úÖ descri√ß√µes VOLTARAM (com bullets), cortando s√≥ o excesso -->
              <div class="meta">
                ${meta.filter(Boolean).map(x=>`<span>‚Ä¢ ${escapeHtml(x)}</span>`).join("")}
              </div>

              <div class="prices">
                <div class="p"><small>Custo base:</small> ${usd.format(Number(w.base_cost||0))}</div>
                <div class="p"><small>BRL:</small> ${c==null ? "‚Äî" : brl.format(c)}</div>
              </div>
            </div>

            <div class="itemRight">
              <div class="qtyGrid">
                <div class="qtyMini">
                  <label>cxs</label>
                  <input class="qtyInput" inputmode="numeric" value="0"
                    data-qtybox="boxes" data-wid="${escapeHtml(w.id)}" />
                </div>
                <div class="qtyMini">
                  <label>un</label>
                  <input class="qtyInput" inputmode="numeric" value="0"
                    data-qtybox="units" data-wid="${escapeHtml(w.id)}" />
                </div>
              </div>

              <div class="addRow">
                <button class="btnGhost" type="button" data-clear="${escapeHtml(w.id)}">Limpar</button>
                <button class="btnMini" type="button" data-add="${escapeHtml(w.id)}">Adicionar</button>
              </div>

              <div class="hint">Dica: clique no campo e digite. (zera autom√°tico)</div>
            </div>
          </div>
        `;
      }).join("");

      $$("input[data-qtybox]").forEach(inp=>{
        inp.addEventListener("focus", ()=>{
          const v = String(inp.value||"").trim();
          if(v === "0") inp.value = "";
        });
        inp.addEventListener("blur", ()=>{
          const v = String(inp.value||"").trim();
          if(v === "") inp.value = "0";
        });
        inp.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){
            const id = inp.getAttribute("data-wid");
            addFromRow(id);
          }
        });
      });

      $$("[data-clear]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-clear");
          const b = document.querySelector(`input[data-qtybox="boxes"][data-wid="${CSS.escape(String(id))}"]`);
          const u = document.querySelector(`input[data-qtybox="units"][data-wid="${CSS.escape(String(id))}"]`);
          if(b) b.value = "0";
          if(u) u.value = "0";
        });
      });

      $$("[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-add");
          addFromRow(id);
        });
      });

      renderMoreButton(filteredAll.length);
      updateCartUI(false);
    }

    function addFromRow(id){
      const wine = dataMap.get(String(id));
      if(!wine) return;

      const boxInp = document.querySelector(`input[data-qtybox="boxes"][data-wid="${CSS.escape(String(id))}"]`);
      const unitInp = document.querySelector(`input[data-qtybox="units"][data-wid="${CSS.escape(String(id))}"]`);

      const boxes = clampInt(Math.round(toNumSmart(boxInp?.value) || 0), 0, 999);
      const units = clampInt(Math.round(toNumSmart(unitInp?.value) || 0), 0, 9999);

      if(boxes<=0 && units<=0){
        alert("Digite uma quantidade em cxs ou un.");
        return;
      }

      addToCart(wine, boxes, units);

      if(boxInp) boxInp.value = "0";
      if(unitInp) unitInp.value = "0";
    }

    // =========================
    // CART + PR√âVIA + PDF
    // (mantido igual ao seu √∫ltimo, sem mexer na l√≥gica)
    // =========================
    const cartOverlay = byId("cartOverlay");
    const previewOverlay = byId("previewOverlay");

    function showOverlay(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
    function hideOverlay(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }

    function addToCart(wine, addBoxes, addUnits){
      const existing = cart.find(x=>String(x.id)===String(wine.id));
      if(existing){
        existing.boxes = clampInt((existing.boxes || 0) + Number(addBoxes||0), 0, 999);
        existing.units = clampInt((existing.units || 0) + Number(addUnits||0), 0, 9999);
      }else{
        cart.push({ id: wine.id, boxes: Number(addBoxes||0), units: Number(addUnits||0) });
      }
      updateCartUI(true);
    }

    function removeFromCart(id){
      const idx = cart.findIndex(x=>String(x.id)===String(id));
      if(idx>=0) cart.splice(idx,1);
      updateCartUI(true);
    }

    function setQty(id, field, value){
      const line = cart.find(x=>String(x.id)===String(id));
      if(!line) return;

      const n = toNumSmart(value);
      const v = Math.round(n || 0);

      if(field === "units"){
        line.units = clampInt(v, 0, 9999);
      } else {
        line.boxes = clampInt(v, 0, 999);
      }
      updateCartUI(true);
    }

    function cartTotals(){
      let totalBoxes = 0;
      let totalUnits = 0;
      let totalCost = 0;
      const fx = getFx();

      cart.forEach(line=>{
        const w = dataMap.get(String(line.id));
        if(!w) return;

        const boxes = Number(line.boxes || 0);
        const units = Number(line.units || 0);

        totalBoxes += boxes;
        totalUnits += units;

        const lc = lineCostBRL(w, boxes, units);
        if(lc!=null) totalCost += lc;
      });

      return { totalBoxes, totalUnits, totalCost, ok: !!fx };
    }

    function openCart(){
      renderCart();
      showOverlay(cartOverlay);
    }
    function closeCart(){ hideOverlay(cartOverlay); }

    byId("btnOpenCart").addEventListener("click", openCart);
    byId("cartSummary").addEventListener("click", openCart);
    byId("btnCloseCart").addEventListener("click", closeCart);
    cartOverlay.addEventListener("click", (e)=>{ if(e.target===cartOverlay) closeCart(); });

    byId("btnReload").addEventListener("click", loadData);

    function renderCart(){
      const t = cartTotals();
      byId("warnFx").classList.toggle("show", !t.ok);

      const meta = `Cliente: ${getClientName() || "‚Äî"} ‚Ä¢ √öltima atualiza√ß√£o: ${lastUpdateTextBR}`;
      byId("cartMetaLine").textContent = meta;

      const cartList = byId("cartList");

      if(cart.length===0){
        cartList.innerHTML = `
          <div class="pvBox" style="padding:12px">
            <b>Pedido vazio</b>
            <div class="hint">Volte no cat√°logo, digite quantidades e clique em ‚ÄúAdicionar‚Äù.</div>
          </div>
        `;
        return;
      }

      cartList.innerHTML = cart.map(line=>{
        const w = dataMap.get(String(line.id));
        if(!w) return "";

        const perUnit = unitCostBRL(w);
        const lineCost = lineCostBRL(w, line.boxes, line.units);

        const metaLine = [
          w.category, w.brand, w.producer,
          w.country ? `${w.country_flag} ${w.country}` : "",
          w.region, w.grape,
          w.vintage ? `Safra ${w.vintage}` : "",
          w.size_ml ? sizeLabelFromML(w.size_ml) : "",
          fmtStockAndCxs(w),
          fmtDiscountMax(w)
        ].filter(Boolean).join(" ‚Ä¢ ");

        return `
          <div class="pvBox" style="padding:12px" data-line="${escapeHtml(line.id)}">
            <div style="display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap">
              <div style="flex:1; min-width:240px">
                <b style="display:block">${escapeHtml(w.name)}</b>
                <div class="meta" style="max-height:44px">${escapeHtml(metaLine)}</div>
                <div class="hint">Unit BRL: <b>${perUnit==null ? "‚Äî" : brl.format(perUnit)}</b></div>
              </div>

              <div style="min-width:240px; display:flex; flex-direction:column; gap:8px; align-items:flex-end">
                <div style="font-weight:1100; color:#16a34a">${lineCost==null ? "‚Äî" : brl.format(lineCost)}</div>

                <div class="qtyGrid" style="width:100%">
                  <div class="qtyMini">
                    <label>cxs</label>
                    <input class="qtyInput" inputmode="numeric"
                      value="${escapeHtml(String(line.boxes ?? 0))}"
                      data-cartqty="boxes" data-id="${escapeHtml(line.id)}" />
                  </div>
                  <div class="qtyMini">
                    <label>un</label>
                    <input class="qtyInput" inputmode="numeric"
                      value="${escapeHtml(String(line.units ?? 0))}"
                      data-cartqty="units" data-id="${escapeHtml(line.id)}" />
                  </div>
                </div>

                <button class="btnGhost" type="button" data-del="${escapeHtml(line.id)}" style="width:100%">Remover</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      $$("[data-del]").forEach(b=> b.addEventListener("click", ()=> removeFromCart(b.getAttribute("data-del"))));

      $$("input[data-cartqty]").forEach(inp=>{
        inp.addEventListener("focus", ()=>{
          const v = String(inp.value||"").trim();
          if(v === "0") inp.value = "";
        });
        inp.addEventListener("blur", ()=>{
          const id = inp.getAttribute("data-id");
          const field = inp.getAttribute("data-cartqty");
          const v = String(inp.value||"").trim();
          setQty(id, field, v === "" ? "0" : v);
          if(v === "") inp.value = "0";
        });
        inp.addEventListener("keydown", (e)=>{
          if(e.key === "Enter") inp.blur();
        });
      });
    }

    function updateCartUI(rerenderSheet){
      const t = cartTotals();
      byId("cartCount").textContent = String((t.totalBoxes || 0) + (t.totalUnits || 0));
      byId("cartMiniTotal").textContent = brl.format(t.totalCost || 0);

      if(rerenderSheet && cartOverlay.classList.contains("show")){
        renderCart();
      }
    }

    byId("btnClearCart").addEventListener("click", ()=>{
      cart.length = 0;
      updateCartUI(true);
    });

    function openPreview(){
      const t = cartTotals();
      byId("warnFx2").classList.toggle("show", !t.ok);

      if(cart.length === 0){
        alert("Seu pedido est√° vazio.");
        return;
      }

      const client = getClientName() || "‚Äî";
      byId("pvTitle").textContent = `Pedido ‚Äî ${client}`;
      byId("pvMeta").textContent = `√öltima atualiza√ß√£o: ${lastUpdateTextBR} ‚Ä¢ C√¢mbio: ${getFx()!=null ? getFx() : "‚Äî"}`;
      byId("pvTotal").textContent = brl.format(t.totalCost || 0);
      byId("pvCounts").textContent = `${t.totalBoxes} cxs ‚Ä¢ ${t.totalUnits} un`;

      const table = byId("pvTable");
      table.innerHTML = `
        <thead>
          <tr>
            <th>#</th>
            <th>Produto</th>
            <th>Pa√≠s</th>
            <th class="pvRight">cxs</th>
            <th class="pvRight">un</th>
            <th class="pvRight">Unit BRL</th>
            <th class="pvRight">Total BRL</th>
          </tr>
        </thead>
        <tbody>
          ${cart.map((line, idx)=>{
            const w = dataMap.get(String(line.id));
            if(!w) return "";
            const unit = unitCostBRL(w);
            const total = lineCostBRL(w, line.boxes, line.units);
            const countryName = (w.country || "").trim();
            return `
              <tr>
                <td class="pvMono">${idx+1}</td>
                <td>${escapeHtml(w.name)}</td>
                <td>${escapeHtml(countryName || "‚Äî")}</td>
                <td class="pvRight pvMono">${escapeHtml(String(line.boxes||0))}</td>
                <td class="pvRight pvMono">${escapeHtml(String(line.units||0))}</td>
                <td class="pvRight pvMono">${unit==null ? "‚Äî" : escapeHtml(brl.format(unit))}</td>
                <td class="pvRight pvMono">${total==null ? "‚Äî" : escapeHtml(brl.format(total))}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      `;

      showOverlay(previewOverlay);
    }

    function closePreview(){ hideOverlay(previewOverlay); }

    byId("btnOpenPreview").addEventListener("click", openPreview);
    byId("btnExport").addEventListener("click", openPreview);
    byId("btnClosePreview").addEventListener("click", closePreview);
    byId("btnBackToCart").addEventListener("click", ()=>{ closePreview(); openCart(); });
    previewOverlay.addEventListener("click", (e)=>{ if(e.target===previewOverlay) closePreview(); });

    function nowBR(){
      const d = new Date();
      return fmtBR(d);
    }

    function exportPDF(){
      const t = cartTotals();
      if(cart.length === 0){
        alert("Seu pedido est√° vazio. Adicione itens primeiro.");
        return;
      }
      if(!window.jspdf || !window.jspdf.jsPDF){
        alert("PDF ainda n√£o carregou. Tenta de novo em 2 segundos.");
        return;
      }

      const fx = getFx();
      const client = getClientName() || "‚Äî";

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 36;

      const col = { n: 24, prod: 240, pais: 90, cxs: 40, un: 40, unit: 70, total: 70 };
      const tableW = col.n + col.prod + col.pais + col.cxs + col.un + col.unit + col.total;
      const startX = Math.max(margin, (pageW - tableW) / 2);

      function header(y){
        doc.setFont("helvetica","bold");
        doc.setFontSize(14);
        doc.text("Pedido (cxs + un) ‚Äî Carta de Vinhos", pageW/2, y, { align:"center" });
        y += 18;

        doc.setFont("helvetica","normal");
        doc.setFontSize(10);
        doc.text(`Cliente: ${client}`, pageW/2, y, { align:"center" }); y += 14;
        doc.text(`Gerado em: ${nowBR()} ‚Ä¢ √öltima atualiza√ß√£o: ${lastUpdateTextBR} ‚Ä¢ C√¢mbio: ${fx!=null ? fx : "‚Äî"}`, pageW/2, y, { align:"center" }); y += 16;

        doc.setFont("helvetica","bold");
        doc.text(`Total cxs: ${t.totalBoxes}   |   Total un: ${t.totalUnits}   |   Total (BRL): ${brl.format(t.totalCost || 0)}`, pageW/2, y, { align:"center" });
        y += 18;

        doc.setFontSize(9);
        doc.setFillColor(249, 250, 251);
        doc.rect(startX, y, tableW, 22, "F");

        doc.setTextColor(17, 24, 39);
        doc.text("#", startX + 6, y + 14);
        doc.text("Produto", startX + col.n + 6, y + 14);
        doc.text("Pa√≠s", startX + col.n + col.prod + 6, y + 14);

        doc.text("cxs", startX + col.n + col.prod + col.pais + col.cxs - 6, y + 14, { align:"right" });
        doc.text("un",  startX + col.n + col.prod + col.pais + col.cxs + col.un - 6, y + 14, { align:"right" });
        doc.text("Unit", startX + col.n + col.prod + col.pais + col.cxs + col.un + col.unit - 6, y + 14, { align:"right" });
        doc.text("Total",startX + tableW - 6, y + 14, { align:"right" });

        doc.setDrawColor(229, 231, 235);
        doc.rect(startX, y, tableW, 22);

        return y + 22;
      }

      function row(y, cells){
        const h = cells.h;

        doc.setDrawColor(229, 231, 235);
        doc.rect(startX, y, tableW, h);

        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(15, 23, 42);

        const yText = y + 12;

        doc.text(String(cells.n), startX + 6, yText);
        doc.text(cells.prod, startX + col.n + 6, yText, { maxWidth: col.prod - 12 });
        doc.text(cells.pais, startX + col.n + col.prod + 6, yText, { maxWidth: col.pais - 12 });

        doc.text(String(cells.cxs), startX + col.n + col.prod + col.pais + col.cxs - 6, yText, { align:"right" });
        doc.text(String(cells.un),  startX + col.n + col.prod + col.pais + col.cxs + col.un - 6, yText, { align:"right" });
        doc.text(cells.unit, startX + col.n + col.prod + col.pais + col.cxs + col.un + col.unit - 6, yText, { align:"right" });
        doc.text(cells.total, startX + tableW - 6, yText, { align:"right" });

        return y + h;
      }

      let y = margin;
      y = header(y);

      cart.forEach((line, idx)=>{
        const w = dataMap.get(String(line.id));
        if(!w) return;

        const countryName = (w.country || "").trim();
        const unit = unitCostBRL(w);
        const total = lineCostBRL(w, line.boxes, line.units);

        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        const prodLines = doc.splitTextToSize(String(w.name || ""), col.prod - 12);
        const lines = Math.min(2, prodLines.length);
        const h = 18 + (lines-1)*10;

        if(y + h + 60 > pageH){
          doc.addPage();
          y = margin;
          y = header(y);
        }

        const prodTxt = prodLines.slice(0,2).join(" ");
        y = row(y, {
          h,
          n: idx+1,
          prod: prodTxt,
          pais: countryName || "‚Äî",
          cxs: Number(line.boxes||0),
          un: Number(line.units||0),
          unit: unit==null ? "‚Äî" : brl.format(unit),
          total: total==null ? "‚Äî" : brl.format(total),
        });
      });

      doc.setFont("helvetica","normal");
      doc.setFontSize(9);
      doc.setTextColor(107,114,128);
      doc.text("Obs: custo estimado em BRL. Caixas usam DUN Un como itens por caixa.", pageW/2, pageH - 24, { align:"center" });

      doc.save(`pedido_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    byId("btnExportFinal").addEventListener("click", exportPDF);

    // INIT
    loadData();
  </script>
</body>
</html>
